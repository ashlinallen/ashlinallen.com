!function(e){function t(t){return"".trim?t.val().trim():e.trim(t.val())}e.fn.isHappy=function(n){function s(e){return!!(e&&e.constructor&&e.call&&e.apply)}function i(t){var s=n.classes&&n.classes.message||"unhappyMessage";return e('<span id="'+t.id+'" class="'+s+'" role="alert">'+t.message+"</span>")}function a(e){return s(n.errorTemplate)?n.errorTemplate(e):i(e)}function r(){var e,t,i=!1;for(e=0,t=p.length;t>e;e+=1)p[e].testValid(!0)||(i=!0);return i?(s(n.unHappy)&&n.unHappy(),!1):n.testMode?(s(n.happy)&&n.happy(),window.console&&console.warn("would have submitted"),!1):void(s(n.happy)&&n.happy())}function o(){c=!1}function u(){c=!0,e(window).bind("mouseup",o)}function l(i,r){var o=e(r),u={message:i.message||"",id:r.slice(1)+"_unhappy"},l=e(u.id).length>0?e(u.id):a(u),d=function(){c?e(window).bind("mouseup",o.testValid.bind(this)):o.testValid()};p.push(o),o.testValid=function(a){var r,u,d,p=e(this),c=i.errorTarget&&e(i.errorTarget)||p,h=!1,m=!!p.get(0).attributes.getNamedItem("required")||i.required,f="password"===o.attr("type"),g=s(i.arg)?i.arg():i.arg,v=n.classes&&n.classes.field||"unhappy";return p.length>1?(r=[],p.each(function(t,n){r.push(e(n).val())}),r=r.join(",")):(r=s(i.clean)?i.clean(p.val()):!f&&"undefined"==typeof i.trim||i.trim?t(p):p.val(),p.val(r)),u=(r.length>0||"sometimes"===m)&&s(i.test),a===!0&&m===!0&&0===r.length?h=!0:u&&(h=!i.test(r,g)),h?(c.addClass(v).after(l),!1):(d=l.get(0),d.parentNode&&d.parentNode.removeChild(d),c.removeClass(v),!0)},o.bind(i.when||n.when||"blur",d)}var d,p=[],c=!1;for(d in n.fields)l(n.fields[d],d);return e(n.submitButton||this).bind("mousedown",u),n.submitButton?e(n.submitButton).click(r):this.bind("submit",r),this}}(this.jQuery||this.Zepto);